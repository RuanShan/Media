
<% content_for :sidebar do %>
    <%= render 'sidebar_ec_shop' %>
<% end %>

<% content_for :topbar do %>
    <h1 class="pagecurrent">分类管理</h1>
<% end %>

<p class="p-note">
  提示：1、设置微电商商品的类别；<br/>
  　　　2、在商品归类后，再修改类别信息或者新增子类别，请注意维护商品的所属类别
</p>

<div id="cont2" class="box-menu cont">
  <div class="menu-fl">
    <div class="menu-hd">
      菜单管理
      <!--<a class="ico ico-add fr" onclick="popUrl(this)" data-name="name" data-w="600" data-h="250" data-title="新增分类" data-url="<%#= new_booking_category_url %>" title="新增子目录"></a>-->
      <%= link_to '', new_ec_seller_cat_url, class: 'ico ico-add fr', title: "新增子目录" %>
    </div>
    <div class="menu-list">
      <% @ec_seller_cats.root.normal.order(:sort_order).each do |menu| %>
          <% if menu.has_children? %>
              <dl menu_id="<%= menu.id %>">
                <dt>
                  <b><%= menu.name %></b>
                  <span>
                    <%= link_to '', new_ec_seller_cat_url(parent_cid: menu.id, parent_id: menu.id), class: 'ico-add', title: "新增子目录" %>
                    <%= link_to '', edit_ec_seller_cat_url(menu), class: 'ico-edit', title: "编辑当前目录" %>
                    <%#= link_to '', ec_seller_cat_path(menu), method: :delete, confirm: "确认删除分类？<br/>SSSSSSSSS", class: "ico-delete", title: "删除当前目录"%>
                    <a class="ico-delete" href="javascript:void(0);" data-method="delete" onclick="pop(this)" data-id="<%= menu.id %>" data-w="300" data-h="180" data-title="系统提示" title="删除当前目录" data-bd="<div class='box-form form-row'><form><p>确认删除分类？<br>分类删除后它和它子分类的商品都将下架</p><p class='tcenter'><a class='btn btn-small btn-orange' href='<%= ec_seller_cat_path(menu) %>' data-method= 'delete'>确认</a>　<input value='取消' class='btn btn-small btn-close'/></p></form></div>"></a>
                    <%= link_to '', 'javascript:void(0);', class: 'ico ico-up', title: "上移", layer: menu.parent ? 1 : 0, menu_id: menu.id, parent_id: menu.parent_id, type: 'up' %>
                    <%= link_to '', 'javascript:void(0);', class: 'ico ico-down', title: "下移", layer: menu.parent ? 1 : 0, menu_id: menu.id, parent_id: menu.parent_id, type: 'down' %>
                  </span>
                </dt>
                <dd id="menu_list_<%= menu.id %>">
                  <%= render :partial=> "sub_menu", :collection => menu.children.normal.order(:sort_order), :as =>:sub_menu %>
                </dd>
              </dl>
          <% else %>
              <p>
                <b><%= menu.name %></b>
                <span>
                  <%= link_to '', new_ec_seller_cat_url(parent_cid: menu.id, parent_id: menu.id), class: 'ico-add', title: "新增子目录" %>
                  <%= link_to '', edit_ec_seller_cat_url(menu), class: 'ico-edit', title: "编辑当前目录" %>
                  <%#= link_to '', ec_seller_cat_path(menu), method: :delete, confirm: "确认删除分类？", class: "ico-delete", title: "删除当前目录" %>
                  <a class="ico-delete" href="javascript:void(0);"  onclick="pop(this)" data-id="<%= menu.id %>" data-w="300" data-h="180" data-title="系统提示" title="删除当前目录" data-bd="<div class='box-form form-row'><form><p>确认删除分类？<br>分类删除后它和它子分类的商品都将下架</p><p class='tcenter'><a class='btn btn-small btn-orange' href='<%= ec_seller_cat_path(menu) %>' data-method= 'delete'>确认</a>　<input value='取消' class='btn btn-small btn-close'/></p></form></div>"></a>
                  <%= link_to '', 'javascript:void(0);', class: 'ico ico-up', title: "上移", layer: menu.parent ? 1 : 0, menu_id: menu.id, parent_id: menu.parent_id, type: 'up'  %>
                  <%= link_to '', 'javascript:void(0);', class: 'ico ico-down', title: "下移", layer: menu.parent ? 1 : 0, menu_id: menu.id, parent_id: menu.parent_id, type: 'down' %>
                </span>
              </p>
          <% end %>
      <% end %>
    </div>
  </div>

  <% if params[:action] == 'index' %>
      <div class="menu-fr">
        <div id="side_message"><span>请点击左侧菜单进行自定义菜单编辑</span></div>
      </div>
  <% else %>
      <div class="menu-fr">
        <%= form_for @ec_seller_cat, validate: true do |f| %>
            <%= f.hidden_field :ec_shop_id %>
            <%= f.hidden_field :parent_cid %>
            <%= f.hidden_field :parent_id %>
            <%= f.hidden_field :supplier_id %>
            <%= f.hidden_field :wx_mp_user_id %>
            <div class="box-form form-row">
              <div class="p">
                <span>分类名称<span class="fgray"><em>*</em>（必填，不能超过8个字）</span></span>
                <%= f.text_field :name, class: "input-text", maxlength: 8, validate: true %>
              </div>

              <p class="tleft">
                <input type="submit" value="保存" class="btn btn-small btn-orange"/>　　
                <input type="reset" value="重置" class="btn btn-small" id="reset"/>
              </p>
            </div>
        <% end %>
      </div>
  <% end %>
</div>


  <style>

      .box-menu .ico-up{
          width: 16px;
      }
      .box-menu .ico-down{
          width: 16px;
      }
  </style>
  <script type="text/javascript">
      $(function() {
          $(".menu-list").on("click", ".ico-up, .ico-down", function(){
              var active_ids = [];
              $.each($(".menu-list dl"), function(index, value){
                  if($(value).attr('class') == 'active'){
                      active_ids.push($(value).attr('menu_id'));
                      // console.log(active_ids);
                  }

              });
              var self = $(this);
              $.ajax({
                  type: "GET",
                  url: "/ec_seller_cats/" + self.attr('menu_id') +"/update_sorts?type=" + self.attr('type'),
                  success: function(data) {
                      if(parseInt(data) == 1){
                          showTip("success", "当前菜单已排在最前");
                          return false;
                      }else if(parseInt(data) == -1){
                          showTip("success", "当前菜单已排在最后");
                          return false;
                      }
                      var layer = self.attr('layer');
                      if(layer == '0'){
                          $(".menu-list").html(data);
                      }else{
                          $("#menu_list_" +  self.attr('parent_id')).html(data);
                      }
                      $.each($(".menu-list dl"), function(index, value){
                          if( $.inArray($(value).attr('menu_id'), active_ids) != -1){
                              $(value).attr('class', 'active');
                          }else{
                              $(value).attr('class', '');
                          }
                      });
                      showTip("success", "操作成功");
                      return false;
                  },
                  error: function() {
                      return false;
                      showTip("warning", "操作失败");
                  }
              });
          });
          $('.tleft').on("click", '#reset', function(){
              $('#ec_seller_cat_name').val('');
              $('#ec_seller_cat_name').attr('value', '');
              $('form').resetClientSideValidations();
          });
      });
  </script>