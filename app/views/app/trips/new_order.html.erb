
<header>
  <a href="<%= app_trips_url %>" class="ico-prev tleft"><img src="/assets/mobile/wtrave/ico-back.png"></a>
  <h1>填写预订单</h1>
  <a href="<%= order_list_app_trips_url %>" class="tright"><img src="/assets/mobile/wtrave/ico-order.png"></a>
</header><!-- header end -->
<section>
 <%= form_tag "/app/trips/create_order", id: "order_form" do %>
 <input type="hidden" name="order[trip_ticket_id]" value="<%= @ticket.id %>"/>
  <div class="box box-order">
    <dl>
      <dt>商品信息</dt>
      <dd>
        <div class="order-row">
          <div class="fl">门票名称：</div>
          <div class="fr"><span><%= @ticket.name %></span></div>
          <input type="hidden" name="order[ticket_name]" value="<%= @ticket.name %>"/>
        </div>
        <div class="order-row">
          <div class="fl">游玩时间：</div>
          <div class="fr"><input type="date" name="order[booking_at]"></div>
        </div>
        <div class="order-row">
          <div class="fl">门票单价：</div>
          <div class="fr fred tright"><span>￥<%= format("%.2f",@ticket.price) %></span></div>
          <input type="hidden" name="order[price]" value="<%= format("%.2f",@ticket.price) %>"/>
        </div>
        <div class="order-row order-number">
          <div class="fl">预定数量：</div>
          <div class="fr">
            <div class="box-number">
              <i id="down">-</i>
              <input type="tel" name="order[qty]" value="1">
              <i id="up">+</i>
            </div>
          </div>
        </div>
        <div class="order-row">
          <div class="fl">门票总价：</div>
          <div class="fr fred tright"><span id="total_amount">￥<%= format("%.2f",@ticket.price) %></span></div>
          <input type="hidden" name="order[total_amount]" value="<%= format("%.2f",@ticket.price) %>"/>
        </div>
      </dd>
    </dl>
    <dl>
      <dt>个人信息</dt>
      <dd>
        <div class="order-row">
          <div class="fl">联系人：</div>
          <div class="fr"><input type="text" name="order[username]" value="<%= @wx_user.try(:nickname) %>"></div>
        </div>
        <div class="order-row order-input">
          <div class="fl">手机号码：</div>
          <div class="fr"><input type="tel" name="order[tel]" value="<%= @wx_user.try(:mobile) %>"></div>
        </div>
      </dd>
    </dl>
    <p class="tcenter">
      <input type="botton" class="btn" value="提交订单" onclick="save_form()" readonly>
    </p>
  </div><!--box-order end -->
  <div class="box-note">
    <b>预定须知</b>
    <p><%= @ticket.content.to_s.html_safe %></p>
  </div><!--box-note end-->
<% end %>
</section><!-- section end -->
<script type="text/javascript">
function save_form(){
  if($("[name='order[username]']").val() == ""){
    alert("请填写联系人！");
    $("[name='order[username]']").focus();
  }else if($("[name='order[tel]']").val() == ""){
    alert("请填写手机号码！");
    $("[name='order[tel]']").focus();
  }else if(!$("[name='order[tel]']").val().match(/^1[3|4|5|8][0-9]\d{4,8}$/)){
      alert("请填写正确的手机号码！");
      $("[name='order[tel]']").focus();
  }else if($("[name='order[booking_at]']").val() == ""){
      alert("请填写游玩时间！");
      $("[name='order[booking_at]']").focus();
  }else{
    $('#order_form').submit();
  }
}
$("[name='order[qty]']").change(function(){
  var count = parseInt($(this).val());
  var price = parseFloat($("[name='order[price]']").val());
  var total_amount = count * price
  $('#total_amount').text("￥" + total_amount.toFixed(2));
  $("[name='order[total_amount]']").val(total_amount.toFixed(2));
});

$("#up").click(function(){
  var count = parseInt($("[name='order[qty]']").val());
  $("[name='order[qty]']").val(count+1).change();
});

$("#down").click(function(){
  var count = parseInt($("[name='order[qty]']").val());
  $("[name='order[qty]']").val(count-1 < 1 ? "1" : count-1).change();
});
</script>